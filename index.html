<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>NDIMBAL LOC ‚Äî R√©glage propri√©taire</title>
<meta name="theme-color" content="#065f46">

<style>
:root{
  --bg1:#022c22; --bg2:#065f46;
  --card:rgba(0,0,0,.28);
  --line:rgba(255,255,255,.12);
  --ink:#e5e7eb; --muted:rgba(229,231,235,.75);
  --gold:#facc15; --ok:#22c55e; --bad:#f97373;
  --shadow:0 20px 40px rgba(0,0,0,.35);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  color:var(--ink);
  display:flex;align-items:center;justify-content:center;
  padding:16px;
}
.card{
  width:460px;max-width:96%;
  background:var(--card);
  border-radius:18px;
  padding:22px;
  backdrop-filter:blur(6px);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
}
.top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
h1{font-size:20px;margin:0}
.pill{
  border:1px solid rgba(255,255,255,.18);
  padding:6px 10px;border-radius:999px;
  font-weight:900;font-size:12px;color:var(--muted);
  background:rgba(255,255,255,.06);
}
.desc{
  margin-top:10px;
  font-size:13px;
  opacity:.9;
  line-height:1.5em;
}
.switch{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:14px;
  padding:12px 14px;
  border-radius:12px;
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
}
.state{font-weight:950;font-size:15px}
.btnRow{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
button,a{
  flex:1;min-width:180px;
  border:0;border-radius:12px;
  padding:12px;
  font-weight:950;
  font-size:14px;
  cursor:pointer;
  text-decoration:none;
  display:flex;align-items:center;justify-content:center;
}
button{background:var(--gold);color:#052e16}
a{background:rgba(255,255,255,.08);color:var(--ink);border:1px solid var(--line)}
a:hover{filter:brightness(1.08)}
button:disabled{opacity:.55;cursor:not-allowed}
.notice{
  margin-top:14px;
  font-size:12px;
  color:var(--muted);
  line-height:1.4em;
}
.note{
  margin-top:12px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  font-size:12px;
  white-space:pre-wrap;
  display:none;
}
.note.ok{display:block;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10);color:#bbf7d0}
.note.bad{display:block;border-color:rgba(249,115,115,.35);background:rgba(249,115,115,.10);color:#fecaca}
</style>
</head>
<body>

<div class="card">
  <div class="top">
    <h1>ü§ç NDIMBAL LOC</h1>
    <div class="pill" id="pillSlug">slug: ‚Äî</div>
  </div>

  <div class="desc">
    Active l‚Äôhospitalit√© NDIMBAL sur ton logement.<br>
    <b>1 nuit r√©serv√©e = 2 nuits sur place</b><br>
    <b>2 nuits r√©serv√©es = 3 nuits sur place</b><br><br>
    Tu restes libre. DIGIY ne finance rien.
  </div>

  <div class="switch">
    <div>Statut actuel</div>
    <div class="state" id="state">‚Äî</div>
  </div>

  <div class="btnRow">
    <button id="toggleBtn">Activer / D√©sactiver</button>
    <a id="backCockpit" href="#">‚Ü©Ô∏è Retour cockpit</a>
  </div>

  <div class="note" id="note"></div>

  <div class="notice">
    NDIMBAL = geste volontaire du propri√©taire.<br>
    DIGIY ne collecte ni dons ni argent solidaire.<br>
    L‚Äôoutil organise seulement la r√®gle +1 nuit.
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {
  "use strict";

  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iYwYFQnH1oGJ6fY6uYwqv0g0rVYl0h1bY";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);
  const slug = (new URLSearchParams(location.search).get("slug") || "").trim().toLowerCase();

  $("pillSlug").textContent = "slug: " + (slug || "‚Äî");

  const cockpit = new URL("./index.html", location.href);
  if (slug) cockpit.searchParams.set("slug", slug);
  $("backCockpit").href = cockpit.toString();

  const stateEl = $("state");
  const noteEl = $("note");
  const btn = $("toggleBtn");

  let pinId = null;
  let nd = false;

  function note(msg, cls){
    noteEl.className = "note " + (cls || "");
    noteEl.textContent = msg || "";
    noteEl.style.display = msg ? "block" : "none";
  }

  function paint(){
    stateEl.textContent = nd ? "NDIMBAL ON" : "NDIMBAL OFF";
    stateEl.style.color = nd ? "#22c55e" : "rgba(229,231,235,.75)";
  }

  async function requireSessionOrRedirect(){
    const { data } = await sb.auth.getUser();
    const user = data?.user;
    if (!user){
      // pas connect√© => on renvoie vers la page PIN
      const pin = new URL("./pin.html", location.href);
      if (slug) pin.searchParams.set("slug", slug);
      location.replace(pin.toString());
      return null;
    }
    return user;
  }

  async function load(){
    if(!slug){
      stateEl.textContent = "Slug manquant";
      note("‚ùå Slug manquant.\n‚û°Ô∏è Exemple : ndimbal-loc.html?slug=chez-astou-saly", "bad");
      btn.disabled = true;
      return;
    }

    const user = await requireSessionOrRedirect();
    if(!user) return;

    note("‚è≥ Chargement‚Ä¶", "");
    btn.disabled = true;

    // ‚úÖ owner check : seul le proprio peut modifier
    const { data, error } = await sb
      .from("go_pins")
      .select("id, ndimbal_enabled")
      .eq("category","loc")
      .eq("slug", slug)
      .eq("owner_user_id", user.id)
      .single();

    if(error || !data){
      stateEl.textContent = "Acc√®s refus√©";
      note("‚ùå Tu n‚Äôes pas propri√©taire de ce lieu (ou lieu introuvable).", "bad");
      btn.disabled = true;
      return;
    }

    pinId = data.id;
    nd = !!data.ndimbal_enabled;
    paint();
    note("", "");
    btn.disabled = false;
  }

  async function toggle(){
    if(!pinId) return;

    btn.disabled = true;
    const next = !nd;

    const { error } = await sb
      .from("go_pins")
      .update({ ndimbal_enabled: next, ndimbal_updated_at: new Date().toISOString() })
      .eq("id", pinId);

    btn.disabled = false;

    if(error){
      note("‚ùå Impossible de modifier NDIMBAL.\n‚û°Ô∏è V√©rifie ta connexion puis r√©essaie.", "bad");
      return;
    }

    nd = next;
    paint();
    note(nd ? "‚úÖ NDIMBAL activ√©." : "‚úÖ NDIMBAL d√©sactiv√©.", "ok");
  }

  btn.addEventListener("click", toggle);
  load();
})();
</script>

</body>
</html>
